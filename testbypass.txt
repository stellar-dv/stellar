local TextChatService = game:GetService("TextChatService")

-- Function to handle focus loss
function focuslost(e)
    if e == false then
        return
    end

    -- Function to handle dancing animation commands
    local function dance()
        local textBox = game.Players.LocalPlayer.PlayerGui:FindFirstChild("PlayerChat"):FindFirstChild("Frame"):FindFirstChild("ChatBar"):FindFirstChild("TextBox")
        
        if textBox and textBox.Text:sub(1, 8) == "/e dig" then
            local dance = {
                [""] = "http://www.roblox.com/asset/?id=507772104",
                ["1"] = "http://www.roblox.com/asset/?id=507772104",
                ["2"] = "http://www.roblox.com/asset/?id=507776879",
                ["3"] = "http://www.roblox.com/asset/?id=507777623"
            }

            if dance[textBox.Text:sub(9, 9)] then
                local char = game:GetService("Players").LocalPlayer.Character
                if char and char:FindFirstChildOfClass("Humanoid") then
                    local anim = Instance.new("Animation")
                    anim.AnimationId = dance[textBox.Text:sub(9, 9)]
                    local loaded = char:FindFirstChildOfClass("Humanoid"):LoadAnimation(anim)
                    loaded:Play()
                    char:FindFirstChild("Humanoid").Changed:Connect(function(a)
                        if a == 'MoveDirection' or a == 'Sit' or a == 'Jump' then
                            loaded:Stop()
                        end
                    end)
                    textBox.Text = ''
                end
            end
        end
    end

    -- Run dance function if needed
    dance()

    -- If the text box is empty, return
    if textBox.Text == '' then
        return
    end

    -- Handle sending the message based on the chat version
    if TextChatService.ChatVersion == Enum.ChatVersion.LegacyChatService then
        local Stuff = game:GetService("ReplicatedStorage"):FindFirstChild("DefaultChatSystemChatEvents")
        if not Stuff then
            error("Failed to obtain the DefaultChatSystemChatEvents folder.", 1)
        end
        local Stuff2 = Stuff:FindFirstChild("SayMessageRequest")
        if not Stuff2 then
            error("Failed to obtain the SayMessageRequest event.", 1)
        end
        modifyText(textBox.Text, "All")
    else
        -- For newer chat versions, handle channels
        for _, v in next, TextChatService.TextChannels:GetChildren() do
            if v:FindFirstChild(game:GetService("Players").LocalPlayer.Name) and v.Name ~= 'RBXSystem' then
                modifyText(textBox.Text)
                break
            end
        end
    end

    -- Clear the text box
    textBox.Text = ''
end