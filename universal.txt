local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")

local isAimbotActive = false  -- Flag to check if aimbot should be active

-- Function to create and manage player tag, tracer, and 3D box
local function CreatePlayerVisuals(player)
    local function OnCharacterAdded(character)
        local head = character:WaitForChild("Head", 10) -- Wait for the Head part
        if not head then return end

        -- Create Name Tag
        local tag = Instance.new("BillboardGui")
        tag.Name = "NameTag"
        tag.Adornee = head
        tag.Size = UDim2.new(0, 150, 0, 50)
        tag.StudsOffset = Vector3.new(0, 2, 0)
        tag.AlwaysOnTop = true

        local text = Instance.new("TextLabel")
        text.Size = UDim2.new(1, 0, 1, 0)
        text.BackgroundTransparency = 1
        text.TextScaled = true
        text.TextWrapped = false -- Disable text wrapping
        text.Font = Enum.Font.SourceSansBold
        text.TextStrokeTransparency = 0.5
        text.TextColor3 = player.Team and player.Team.TeamColor.Color or Color3.new(1, 1, 1)
        text.Parent = tag
        tag.Parent = head

        -- Tracer
        local tracer = Drawing.new("Line")
        tracer.Thickness = 1
        tracer.Visible = false

        -- 3D Box
        local box = Instance.new("BoxHandleAdornment")
        box.Name = "PlayerBox"
        box.Adornee = character:WaitForChild("HumanoidRootPart")
        box.Size = Vector3.new(4, 6, 4) -- Size of the box
        box.Color3 = player.Team and player.Team.TeamColor.Color or Color3.new(1, 0, 0) -- Set initial box color
        box.Transparency = 0.5
        box.Visible = false -- Initially set to not visible
        box.Parent = character

        -- Raycasting function to check if the player is visible (not behind walls)
        local function IsVisibleFromCamera(position)
            local ray = Ray.new(Camera.CFrame.Position, (position - Camera.CFrame.Position).unit * (position - Camera.CFrame.Position).Magnitude)
            local hitPart, hitPosition = workspace:FindPartOnRay(ray, character)
            return not hitPart or hitPart:IsDescendantOf(character) -- True if no hit or hit only the character itself
        end

        -- Update Name Tag, Tracer, and 3D Box
        local function UpdateVisuals()
            if character and character:FindFirstChild("HumanoidRootPart") then
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                local rootPart = character.HumanoidRootPart

                -- Update name and distance
                local health = humanoid and math.floor(humanoid.Health) or 0
                local distance = (Camera.CFrame.Position - rootPart.Position).Magnitude
                text.Text = string.format("Name: %s | Health: %d | Distance: %d", player.Name, health, math.floor(distance))

                -- Update tracer
                local screenPosition, onScreen = Camera:WorldToViewportPoint(rootPart.Position)
                if onScreen then
                    tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                    tracer.To = Vector2.new(screenPosition.X, screenPosition.Y)
                    tracer.Visible = true
                    tracer.Color = player.Team and player.Team.TeamColor.Color or Color3.new(1, 1, 1)

                    -- Update the box color to cycle through RGB
                    box.Color3 = Color3.fromHSV(tick() % 5 / 5, 1, 1)  -- Cycles through hue over time

                    -- Only make the box visible if the character is on screen and not obstructed by walls
                    box.Visible = IsVisibleFromCamera(rootPart.Position)
                else
                    tracer.Visible = false
                    box.Visible = false
                end
            else
                tracer.Visible = false
                box.Visible = false
            end
        end

        -- Connect RenderStepped to update Name Tag, Tracer, and Box
        local updateConnection = RunService.RenderStepped:Connect(UpdateVisuals)

        -- Clean up when character dies
        character:WaitForChild("Humanoid").Died:Connect(function()
            tracer.Visible = false
            updateConnection:Disconnect()
            box:Destroy()
        end)
    end

    -- Handle existing character and future ones
    if player.Character then
        OnCharacterAdded(player.Character)
    end
    player.CharacterAdded:Connect(OnCharacterAdded)
end

-- Initialize for all current players
for _, player in ipairs(Players:GetPlayers()) do
    if player ~= Players.LocalPlayer then
        CreatePlayerVisuals(player)
    end
end

-- Listen for new players joining
Players.PlayerAdded:Connect(function(player)
    if player ~= Players.LocalPlayer then
        CreatePlayerVisuals(player)
    end
end)

-- AimBot Logic
local function AimAtClosestTarget()
    -- Check if the aimbot is active
    if not isAimbotActive then return end

    -- Find the closest enemy player
    local closestPlayer = nil
    local closestDistance = math.huge
    local closestDot = -math.huge  -- Used to measure how within FOV the player is

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            -- Only aim at players not on the same team
            if player.Team ~= Players.LocalPlayer.Team then
                local rootPart = player.Character.HumanoidRootPart
                local screenPosition, onScreen = Camera:WorldToViewportPoint(rootPart.Position)

                -- Only consider players that are visible
                if onScreen and IsVisibleFromCamera(rootPart.Position) then
                    local distance = (Camera.CFrame.Position - rootPart.Position).Magnitude
                    local direction = (rootPart.Position - Camera.CFrame.Position).unit

                    -- Calculate FOV Dot product to check if within FOV
                    local viewDir = Camera.CFrame.LookVector
                    local dot = direction:Dot(viewDir)

                    -- If the player is closer and within FOV, consider them
                    if dot > closestDot and distance < closestDistance and dot > 0.5 then
                        closestDot = dot
                        closestDistance = distance
                        closestPlayer = player
                    end
                end
            end
        end
    end

    -- Aim silently at the closest player
    if closestPlayer then
        local targetPart = closestPlayer.Character:FindFirstChild("Head") or closestPlayer.Character:FindFirstChild("HumanoidRootPart")
        if targetPart then
            local direction = (targetPart.Position - Camera.CFrame.Position).unit
            local targetPosition = Camera.CFrame.Position + direction * 10  -- Adjust the aim silently
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, targetPosition)  -- Update camera to aim at target
        end
    end
end

-- Listen for Mouse Button Input to toggle Aimbot
UserInputService.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isAimbotActive = true
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isAimbotActive = false
    end
end)

-- Continuously check and aim at the closest target
RunService.RenderStepped:Connect(AimAtClosestTarget)